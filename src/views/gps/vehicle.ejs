<%
  // Helper: ISO/UTC tarihini GMT+3 (T√ºrkiye) formatƒ±na √ßevir
  function toGMT3(dateStr) {
    if (!dateStr) return '‚Äî';
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    } catch (e) {
      return dateStr;
    }
  }
%>
<style>
  .gps-page { padding: 12px 20px 28px; }
  .gps-header {
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin: 10px 0 14px;
  }
  .gps-title { margin:0; font-size: 18px; font-weight: 900; color: var(--text-primary); }
  .gps-sub { margin: 6px 0 0; color: var(--text-muted); font-size: 12px; font-weight: 600; }

  .gps-grid { display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 14px; align-items: start; }
  @media (max-width: 980px) { .gps-grid { grid-template-columns: 1fr; } }

  .gps-card { border-radius: 14px; border: 1px solid var(--border-subtle); background: var(--bg-card); box-shadow: var(--shadow-md); overflow:hidden; }
  .gps-card-header { padding: 12px; border-bottom: 1px solid var(--border-subtle); display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
  .gps-card-title { margin:0; font-size: 13px; font-weight: 800; color: var(--text-secondary); letter-spacing: 0.2px; }
  .gps-body { padding: 12px; }

  .gps-kv { display:grid; grid-template-columns: 140px 1fr; gap: 10px; margin: 8px 0; }
  .gps-k { color: var(--text-muted); font-weight: 800; font-size: 12px; }
  .gps-v { color: var(--text-primary); font-weight: 700; font-size: 12px; }

  .gps-map { height: 520px; width: 100%; }
  @media (max-width: 980px) { .gps-map { height: 380px; } }

  .gps-table-wrap { overflow-x: auto; border-top: 1px solid var(--border-subtle); }
  table { width:100%; border-collapse: separate; border-spacing:0; min-width: 720px; }
  thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--table-header-bg);
    color: var(--table-header-text);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    padding: 10px 10px;
    border-bottom: 1px solid var(--table-border);
  }
  tbody td {
    padding: 10px 10px;
    border-bottom: 1px solid var(--border-subtle);
    color: var(--table-cell-text);
    font-size: 12px;
    vertical-align: top;
  }
  tbody tr:nth-child(odd) { background: var(--table-row-odd); }
  tbody tr:nth-child(even) { background: var(--table-row-even); }
  tbody tr:hover { background: var(--table-row-hover); }

  .leaflet-container { background: var(--bg-surface-solid); }
  .leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: var(--bg-card-solid);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
  }
</style>

<%- include('../partials/navbar') %>

<div class="gps-page">
  <div class="gps-header">
    <div>
      <h1 class="gps-title">GPS ¬∑ Ara√ß Detay</h1>
      <div class="gps-sub">
        Ara√ß: <span style="color:var(--text-primary); font-weight:900;"><%= vehicle ? (vehicle.plate || vehicle.vehiclename || vehicle.vehicleid) : '‚Äî' %></span>
        <span style="margin-left:10px;">Son veri: <%= vehicle ? toGMT3(vehicle.time_indicator) : '‚Äî' %></span>
      </div>
    </div>

    <div style="display:flex; gap: 8px; flex-wrap:wrap; align-items:center;">
      <a class="btn btn-outline" href="/gps/live">Canlƒ± Takip</a>
      <button class="btn" id="gpsRefreshBtn" type="button">Yenile</button>
    </div>
  </div>

  <div class="gps-grid">
    <div class="gps-card">
      <div class="gps-card-header">
        <h2 class="gps-card-title">Harita</h2>
        <div class="gps-sub" id="gpsApiStatus" style="margin:0;"></div>
      </div>
      <div id="gpsMap" class="gps-map"></div>
    </div>

    <div class="gps-card">
      <div class="gps-card-header">
        <h2 class="gps-card-title">√ñzet</h2>
      </div>
      <div class="gps-body">
        <div class="gps-kv"><div class="gps-k">Plaka</div><div class="gps-v"><%= vehicle ? (vehicle.plate || vehicle.vehiclename || '‚Äî') : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">≈ûof√∂r</div><div class="gps-v"><%= vehicle ? (vehicle.drivername || '‚Äî') : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">Hƒ±z</div><div class="gps-v"><%= vehicle && vehicle.velocity != null ? (vehicle.velocity + ' km/h') : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">Konum</div><div class="gps-v"><%= vehicle ? (vehicle.location || vehicle.address || '‚Äî') : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">Koordinat</div><div class="gps-v"><%= vehicle && vehicle.latitude != null && vehicle.longitude != null ? (vehicle.latitude + ', ' + vehicle.longitude) : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">Toplam Km</div><div class="gps-v"><%= vehicle && vehicle.totaldistance != null ? vehicle.totaldistance : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">Start Km</div><div class="gps-v"><%= vehicle && vehicle.start_km != null ? vehicle.start_km : '‚Äî' %></div></div>
        <div class="gps-kv"><div class="gps-k">ƒ∞leti≈üim</div><div class="gps-v"><%= vehicle && vehicle.communication != null ? (vehicle.communication ? 'Var' : 'Yok') : '‚Äî' %></div></div>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="gps-card">
    <div class="gps-card-header" style="flex-direction:column; align-items:stretch; gap:12px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 class="gps-card-title">Ge√ßmi≈ü <%= (dateFilter && dateFilter.startDate) ? '' : '(son 24 saat)' %></h2>
        <div class="gps-sub" style="margin:0;">Kayƒ±t: <%= (pagination && pagination.totalRows != null) ? pagination.totalRows : (history || []).length %></div>
      </div>

      <!-- Tarih Filtresi -->
      <form method="GET" action="/gps/vehicle/<%= encodeURIComponent(vehicle.vehicleid) %>" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:10px; background:var(--bg-surface); border-radius:8px; border:1px solid var(--border-subtle);">
        <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Tarih Aralƒ±ƒüƒ±:</label>
        <input type="date" id="reportStartDate" name="startDate" value="<%= (dateFilter && dateFilter.startDate) || '' %>" style="padding:6px 10px; border-radius:6px; border:1px solid var(--border-default); background:var(--bg-card); color:var(--text-primary); font-size:12px;" />
        <span style="color:var(--text-muted); font-size:12px;">‚Äî</span>
        <input type="date" id="reportEndDate" name="endDate" value="<%= (dateFilter && dateFilter.endDate) || '' %>" style="padding:6px 10px; border-radius:6px; border:1px solid var(--border-default); background:var(--bg-card); color:var(--text-primary); font-size:12px;" />
        <button type="submit" class="btn" style="padding:6px 14px; font-size:12px;">Filtrele</button>
        <button type="button" id="openReportBtn" class="btn" style="padding:6px 14px; font-size:12px; background:linear-gradient(90deg,#10b981,#059669);">üìä Rapor</button>
        <% if (dateFilter && (dateFilter.startDate || dateFilter.endDate)) { %>
          <a href="/gps/vehicle/<%= encodeURIComponent(vehicle.vehicleid) %>" class="btn btn-outline" style="padding:6px 14px; font-size:12px;">Sƒ±fƒ±rla</a>
        <% } %>
      </form>

      <% if (pagination && pagination.totalPages && pagination.totalPages > 1) { %>
        <div style="display:flex; gap:6px; align-items:center; justify-content:flex-end;">
          <%
            // Build query string preserving date filters
            const qs = [];
            if (dateFilter && dateFilter.startDate) qs.push('startDate=' + encodeURIComponent(dateFilter.startDate));
            if (dateFilter && dateFilter.endDate) qs.push('endDate=' + encodeURIComponent(dateFilter.endDate));
            const baseQs = qs.length ? '&' + qs.join('&') : '';
          %>
          <% if (pagination.page > 1) { %>
            <a class="btn btn-outline" style="padding:6px 10px; font-size:12px;" href="/gps/vehicle/<%= encodeURIComponent(vehicle.vehicleid) %>?page=<%= pagination.page - 1 %><%= baseQs %>">‚Üê √ñnceki</a>
          <% } else { %>
            <span class="btn btn-outline" style="padding:6px 10px; font-size:12px; opacity:0.5; pointer-events:none;">‚Üê √ñnceki</span>
          <% } %>

          <span class="gps-sub" style="margin:0;">Sayfa <%= pagination.page %> / <%= pagination.totalPages %></span>

          <% if (pagination.page < pagination.totalPages) { %>
            <a class="btn btn-outline" style="padding:6px 10px; font-size:12px;" href="/gps/vehicle/<%= encodeURIComponent(vehicle.vehicleid) %>?page=<%= pagination.page + 1 %><%= baseQs %>">Sonraki ‚Üí</a>
          <% } else { %>
            <span class="btn btn-outline" style="padding:6px 10px; font-size:12px; opacity:0.5; pointer-events:none;">Sonraki ‚Üí</span>
          <% } %>
        </div>
      <% } %>
    </div>
    <div class="gps-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Zaman</th>
            <th>Hƒ±z</th>
            <th>Konum</th>
            <th>Koordinat</th>
          </tr>
        </thead>
        <tbody>
          <% (history || []).forEach(function(h){ %>
            <tr>
              <td><%= toGMT3(h.time_indicator) %></td>
              <td><%= h.velocity != null ? (h.velocity + ' km/h') : '‚Äî' %></td>
              <td><%= h.location || h.address || '‚Äî' %></td>
              <td><%= h.latitude != null && h.longitude != null ? (h.latitude + ', ' + h.longitude) : '‚Äî' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  window.__GPS_VEHICLE_ID__ = <%- JSON.stringify(vehicle ? vehicle.vehicleid : null) %>;
  window.__GPS_LAST__ = <%- JSON.stringify(vehicle || null) %>;
  window.__GPS_HISTORY__ = <%- JSON.stringify(history || []) %>;
</script>

<script>
  (function(){
    let map;
    let marker;
    let poly;

    function setStatus(ok, message){
      const el = document.getElementById('gpsApiStatus');
      el.textContent = message || '';
      el.style.padding = message ? '6px 10px' : '';
      el.style.borderRadius = message ? '999px' : '';
      el.style.border = message ? (ok ? '1px solid var(--border-default)' : '1px solid var(--warning-light)') : '';
      el.style.background = message ? (ok ? 'var(--bg-surface)' : 'var(--warning-light)') : '';
      el.style.color = message ? (ok ? 'var(--text-secondary)' : 'var(--warning-text)') : '';
      el.style.fontWeight = '800';
      el.style.fontSize = '12px';
    }

    function ensureMap(){
      if (map) return;
      map = L.map('gpsMap', { zoomControl: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      map.setView([39.0, 35.0], 5);
    }

    function render(){
      ensureMap();

      const last = window.__GPS_LAST__;
      const history = window.__GPS_HISTORY__ || [];

      const pts = [];
      history.forEach(h => {
        const lat = Number(h.latitude);
        const lng = Number(h.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        pts.push([lat, lng]);
      });

      if (poly) { poly.remove(); poly = null; }
      if (pts.length >= 2) {
        const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        const options = { weight: 3, opacity: 0.85 };
        if (primary) options.color = primary;
        poly = L.polyline(pts, options);
        poly.addTo(map);
      }

      if (marker) { marker.remove(); marker = null; }
      if (last) {
        const lat = Number(last.latitude);
        const lng = Number(last.longitude);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          const popup = `<div style="font-weight:900; margin-bottom:4px;">${(last.plate || last.vehiclename || last.vehicleid || '').toString()}</div>` +
            `<div style="font-size:12px; color: var(--text-muted)">${(last.drivername || '').toString()}</div>` +
            `<div style="margin-top:6px; font-size:12px;">Hƒ±z: ${last.velocity != null ? last.velocity + ' km/h' : '‚Äî'}</div>` +
            `<div style="margin-top:4px; font-size:12px;">${(last.time_indicator || '‚Äî').toString()}</div>`;
          marker = L.marker([lat, lng]).bindPopup(popup);
          marker.addTo(map);
          marker.openPopup();
          map.setView([lat, lng], 12);
        }
      }

      if (pts.length) {
        try {
          const b = L.latLngBounds(pts);
          map.fitBounds(b.pad(0.12));
        } catch (_) {}
      }
    }

    async function manualRefresh(){
      const btn = document.getElementById('gpsRefreshBtn');
      btn.disabled = true;
      try {
        setStatus(true, 'Yenileniyor...');
        const res = await fetch('/api/gps/refresh', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const ct = (res && res.headers && res.headers.get && res.headers.get('content-type')) ? res.headers.get('content-type') : '';
        const data = (ct && ct.toLowerCase().includes('application/json')) ? await res.json() : null;
        if (!data) {
          setStatus(false, 'Yenileme ba≈üarƒ±sƒ±z (JSON yanƒ±tƒ± yok - giri≈ü gerekli olabilir)');
          return;
        }

        const apiError = (typeof data.error === 'string' && data.error.trim()) ? data.error.trim() : null;
        if (data && data.ok && data.vehicles) {
          // find vehicle in refreshed list
          const id = window.__GPS_VEHICLE_ID__;
          const found = data.vehicles.find(v => String(v.vehicleid) === String(id));
          window.__GPS_LAST__ = found || window.__GPS_LAST__;
          setStatus(true, 'Yenilendi');
          render();
        } else {
          if (apiError) setStatus(false, apiError);
          else if (res && (res.status === 401 || res.status === 403)) setStatus(false, 'Yetkiniz yok veya oturum s√ºresi doldu');
          else setStatus(false, 'Yenileme ba≈üarƒ±sƒ±z');
        }
      } catch (e) {
        setStatus(false, (e && e.message) ? e.message : 'Yenileme ba≈üarƒ±sƒ±z');
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('gpsRefreshBtn').addEventListener('click', manualRefresh);
    render();
  })();
</script>

<!-- Drive/Stop Report Modal -->
<style>
  .report-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  .report-modal-overlay.active { display: flex; }
  .report-modal {
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    max-width: 95vw;
    max-height: 90vh;
    width: 1100px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .report-modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg-surface);
  }
  .report-modal-title {
    font-size: 16px;
    font-weight: 900;
    color: var(--text-primary);
    margin: 0;
  }
  .report-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px 8px;
    border-radius: 6px;
  }
  .report-modal-close:hover { background: var(--bg-card); color: var(--text-primary); }
  .report-modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  .report-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .report-summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
  }
  .report-summary-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .report-summary-value {
    font-size: 20px;
    font-weight: 900;
    color: var(--text-primary);
  }
  .report-table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
  }
  .report-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
    font-size: 12px;
  }
  .report-table th {
    background: var(--table-header-bg);
    color: var(--table-header-text);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    padding: 12px 10px;
    text-align: left;
    border-bottom: 2px solid var(--border-default);
    font-size: 11px;
  }
  .report-table td {
    padding: 10px;
    border-bottom: 1px solid var(--border-subtle);
    color: var(--table-cell-text);
    vertical-align: top;
  }
  .report-table tr:nth-child(odd) { background: var(--table-row-odd); }
  .report-table tr:nth-child(even) { background: var(--table-row-even); }
  .report-table tr:hover { background: var(--table-row-hover); }
  .report-type-drive {
    background: linear-gradient(90deg, rgba(59,130,246,0.15), transparent);
    border-left: 4px solid #3b82f6;
  }
  .report-type-stop {
    background: linear-gradient(90deg, rgba(239,68,68,0.1), transparent);
    border-left: 4px solid #ef4444;
  }
  .report-type-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 800;
    font-size: 11px;
  }
  .report-type-badge.drive { background: #3b82f6; color: #fff; }
  .report-type-badge.stop { background: #ef4444; color: #fff; }
  .report-loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
    font-size: 14px;
  }
  .report-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
</style>

<div class="report-modal-overlay" id="reportModalOverlay">
  <div class="report-modal">
    <div class="report-modal-header">
      <h2 class="report-modal-title">üìä S√ºr√º≈ü / Duru≈ü Raporu</h2>
      <button class="report-modal-close" id="closeReportModal">&times;</button>
    </div>
    <div class="report-modal-body" id="reportModalBody">
      <div class="report-loading">Y√ºkleniyor...</div>
    </div>
  </div>
</div>

<script>
(function(){
  const vehicleId = window.__GPS_VEHICLE_ID__;
  const overlay = document.getElementById('reportModalOverlay');
  const body = document.getElementById('reportModalBody');
  const openBtn = document.getElementById('openReportBtn');
  const closeBtn = document.getElementById('closeReportModal');

  function toGMT3Time(dateStr) {
    if (!dateStr) return '‚Äî';
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleTimeString('tr-TR', { timeZone: 'Europe/Istanbul', hour: '2-digit', minute: '2-digit' });
    } catch (e) {
      return dateStr;
    }
  }

  function toGMT3Full(dateStr) {
    if (!dateStr) return '‚Äî';
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    } catch (e) {
      return dateStr;
    }
  }

  async function loadReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
      body.innerHTML = '<div class="report-empty">‚ö†Ô∏è L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßin.</div>';
      return;
    }

    body.innerHTML = '<div class="report-loading">‚è≥ Rapor y√ºkleniyor...</div>';

    try {
      const res = await fetch(`/api/gps/vehicle/${encodeURIComponent(vehicleId)}/report?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`, {
        credentials: 'include'
      });
      const data = await res.json();

      if (!data.ok) {
        body.innerHTML = `<div class="report-empty">‚ùå Hata: ${data.error || 'Bilinmeyen hata'}</div>`;
        return;
      }

      if (!data.segments || data.segments.length === 0) {
        body.innerHTML = '<div class="report-empty">üì≠ Se√ßilen tarih aralƒ±ƒüƒ±nda veri bulunamadƒ±.</div>';
        return;
      }

      const summary = data.summary || {};
      let html = `
        <div class="report-summary">
          <div class="report-summary-card">
            <div class="report-summary-label">Toplam S√ºr√º≈ü</div>
            <div class="report-summary-value" style="color:#3b82f6;">${summary.totalDrive || '0h 0m'}</div>
          </div>
          <div class="report-summary-card">
            <div class="report-summary-label">Toplam Duru≈ü</div>
            <div class="report-summary-value" style="color:#ef4444;">${summary.totalStop || '0h 0m'}</div>
          </div>
          <div class="report-summary-card">
            <div class="report-summary-label">Toplam Mesafe</div>
            <div class="report-summary-value" style="color:#10b981;">${summary.totalDistance || 0} km</div>
          </div>
        </div>

        <div class="report-table-wrap">
          <table class="report-table">
            <thead>
              <tr>
                <th>Tip</th>
                <th>Ba≈ülangƒ±√ß Saati</th>
                <th>Ba≈ülangƒ±√ß Konumu</th>
                <th>Biti≈ü Saati</th>
                <th>Biti≈ü Konumu</th>
                <th>S√ºre</th>
                <th>Mesafe (km)</th>
              </tr>
            </thead>
            <tbody>
      `;

      for (const seg of data.segments) {
        const typeClass = seg.type === 'Drive' ? 'drive' : 'stop';
        const rowClass = seg.type === 'Drive' ? 'report-type-drive' : 'report-type-stop';
        const typeBadge = seg.type === 'Drive' ? 'üöó S√ºr√º≈ü' : 'üõë Duru≈ü';

        html += `
          <tr class="${rowClass}">
            <td><span class="report-type-badge ${typeClass}">${typeBadge}</span></td>
            <td>${toGMT3Time(seg.startTime)}</td>
            <td style="max-width:200px; word-wrap:break-word;">${seg.startLocation || '‚Äî'}</td>
            <td>${toGMT3Time(seg.endTime)}</td>
            <td style="max-width:200px; word-wrap:break-word;">${seg.endLocation || '‚Äî'}</td>
            <td><strong>${seg.duration || '‚Äî'}</strong></td>
            <td>${seg.distance > 0 ? seg.distance : '‚Äî'}</td>
          </tr>
        `;
      }

      html += `
            </tbody>
          </table>
        </div>
      `;

      body.innerHTML = html;

    } catch (e) {
      body.innerHTML = `<div class="report-empty">‚ùå Hata: ${e.message || 'Bilinmeyen hata'}</div>`;
    }
  }

  openBtn.addEventListener('click', () => {
    overlay.classList.add('active');
    loadReport();
  });

  closeBtn.addEventListener('click', () => {
    overlay.classList.remove('active');
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('active');
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('active')) {
      overlay.classList.remove('active');
    }
  });
})();
</script>
